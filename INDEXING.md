# Индексация документов

Этот документ описывает функциональность индексации документов из GitHub репозитория с использованием Ollama для генерации эмбеддингов.

## Описание

Пайплайн индексации документов включает следующие этапы:

1. **Клонирование репозитория** - загрузка документов из GitHub репозитория
2. **Загрузка markdown файлов** - поиск всех `.md` файлов в репозитории
3. **Разбивка на чанки** - разбиение текста на части для обработки
4. **Генерация эмбеддингов** - создание векторных представлений текста через Ollama
5. **Сохранение индекса** - сохранение индекса в JSON файл

## Настройка

### Переменные окружения

```bash
# Ollama конфигурация
export OLLAMA_HOST=http://127.0.0.1:11434
export OLLAMA_EMBEDDING_MODEL=nomic-embed-text

# GitHub конфигурация (опционально, для приватных репозиториев)
export GITHUB_TOKEN=your_github_token
export GITHUB_REPO_URL=https://github.com/Towich/life

# Путь для хранения индекса
export INDEX_STORAGE_PATH=index
```

### Запуск Ollama

Убедитесь, что Ollama запущен и модель `nomic-embed-text` загружена:

```bash
# Запуск Ollama (если еще не запущен)
ollama serve

# Загрузка модели (если еще не загружена)
ollama pull nomic-embed-text
```

## Использование через Telegram

### Команда /index

Запускает процесс индексации документов из настроенного GitHub репозитория:

```
/index
```

Бот отправит сообщение о начале индексации и будет обновлять статус по мере выполнения.

### Команда /indexinfo

Показывает информацию о текущем индексе:

```
/indexinfo
```

Выводит:
- Количество документов
- Количество чанков
- Использованную модель
- Дату создания индекса

## Структура индекса

Индекс сохраняется в JSON файл по пути, указанному в `INDEX_STORAGE_PATH` (по умолчанию `index/index.json`).

Структура файла:

```json
{
  "chunks": [
    {
      "id": "uuid",
      "filePath": "/path/to/file.md",
      "content": "текст чанка",
      "chunkIndex": 0,
      "embedding": [0.123, 0.456, ...],
      "metadata": {
        "file": "file.md",
        "chunkIndex": "0"
      }
    }
  ],
  "createdAt": 1234567890,
  "model": "nomic-embed-text",
  "totalDocuments": 10,
  "totalChunks": 150
}
```

## Параметры разбивки на чанки

По умолчанию используются следующие параметры:
- **Размер чанка**: 1000 символов
- **Перекрытие**: 200 символов

Эти параметры можно изменить в `DocumentService`.

## Обработка ошибок

При возникновении ошибок:
- Проверьте, что Ollama запущен и доступен по адресу `OLLAMA_HOST`
- Убедитесь, что модель `nomic-embed-text` загружена
- Для приватных репозиториев убедитесь, что `GITHUB_TOKEN` установлен и имеет права доступа
- Проверьте логи приложения для детальной информации об ошибках

## Производительность

- Индексация выполняется батчами по 10 чанков (настраивается в `IndexDocumentsUseCase`)
- Время индексации зависит от количества документов и размера текста
- Для больших репозиториев процесс может занять несколько минут

